<!DOCTYPE html>
<html data-bs-theme="dark">
<head>
    <meta charset="utf-8"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/roslibjs/1.1.0/roslib.min.js"></script>       
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.7.3/nipplejs.js"></script>
    <script type="text/javascript">
        var ros = new ROSLIB.Ros({
            url : 'ws://localhost:9090'
        });

        ros.on('connection', function() {
            console.log('Connected to websocket server.');
        });

        ros.on('error', function(error) {
            console.log('Error connecting to websocket server: ', error);
        });

        ros.on('close', function() {
            console.log('Connection to websocket server closed.');
        });

        // Publishing a Topic
        // ------------------

        // var imageTopic = new ROSLIB.Topic({
        //     ros : ros,
        //     name : '/yolov8/annotated_image',
        //     messageType : 'sensor_msgs/Image'
        // });

        // imageTopic.subscribe(function(message)
        // {
        //     var imagedata = "data:image/jpg;base64," + message.data;
        //     document.getElementById('detected_img').setAttribute('src', imagedata);
        // });

        cmd_vel_listener = new ROSLIB.Topic({
            ros : ros,
            name : "/xy_cmd_vel",
            messageType : 'geometry_msgs/Twist'
        });

        move = function (linear, angular) {
            var twist = new ROSLIB.Message({
            linear: {
                x: linear,
                y: 0,
                z: 0
            },
            angular: {
                x: 0,
                y: 0,
                z: angular
            }
            });
        cmd_vel_listener.publish(twist);
        }
        
        createJoystick = function () {
        var options = {
            zone: document.getElementById('zone_joystick'),
            threshold: 0.1,
            position: { left: 50 + '%' },
            mode: 'static',
            size: 150,
            color: '#000000',
        };
        manager = nipplejs.create(options);

        linear_speed = 0;
        angular_speed = 0;

        self.manager.on('start', function (event, nipple) {
            timer = setInterval(function () {
                move(linear_speed, angular_speed);
            }, 25);
        });

        self.manager.on('move', function (event, nipple) {
            max_linear = 2.0; // m/s
            max_angular = 0.8; // rad/s
            max_distance = 75.0; // pixels;
            linear_speed = Math.sin(nipple.angle.radian) * max_linear * nipple.distance/max_distance;
            angular_speed = -Math.cos(nipple.angle.radian) * max_angular * nipple.distance/max_distance;
        });

        self.manager.on('end', function () {
            if (timer) {
                clearInterval(timer);
            }
            self.move(0, 0);
        });
        }

        window.onload = function () {
        createJoystick();
        }






        
        // var cmdVel = new ROSLIB.Topic({
        // ros : ros,
        // name : '/xy_cmd_vel',
        // messageType : 'geometry_msgs/Twist'
        // });<img src="http://localhost:8080/stream?topic=/IMAGE_TOPIC" />
        // x : 0.0,
        // y : 0.0,
        // z : 0.2
        // }
        // });

        console.log("Publishing cmd_vel");
        //move(0.5,0.2)
    </script>
    <link rel="stylesheet" href="../style/style.css" type="text/css">
    <style>
        #actions{
            width:30%;
        }
        .vert-button-group{
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px; /* Adjust padding as needed */
        }
        .vert-button-group button{
            margin-bottom: 10px;
            width: 60%
        }

        #controllers{
            width: 40%;
            display:flex;
            align-items: center;
        }
        .joy-group{
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #zone_joystick{
            margin: 20%
        }
        #control_layout{
            display:flex;
            flex-direction: row;
        }
    </style>
</head>
<body>
    <!-- <div>
        <img id="detected_img" width="320" height="320" src="http://192.168.79.147:8080/stream?topic=/yolov8/annotated_image"/>
    </div> -->

    <div id="control_layout">
        <div id="actions" class="vert-button-group">
            <button type="button" class="btn btn-outline-primary">E-stop</button>
            <button type="button" class="btn btn-outline-primary">Start</button>
            <button type="button" class="btn btn-outline-primary">Move</button> <!--add dropdown functionality-->
            <button type="button" class="btn btn-outline-primary">...</button>
            <button type="button" class="btn btn-outline-primary">Terminate</button>
        </div>
    
        <div id="controllers" class="joy-group">
            <div id="zone_joystick" style="position: relative;"></div>
        </div>
    </div>
</body>


</html>